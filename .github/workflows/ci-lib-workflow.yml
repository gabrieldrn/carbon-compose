name: CI | compile & tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '*' ]

jobs:
  lib-build:
    name: Build library module
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Official Gradle Wrapper Validation Action
        uses: gradle/actions/wrapper-validation@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: adopt

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Set up Gradle cache
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-gradle-${{ github.run_id }}
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper

      - name: Grant execute permission for gradlew script
        run: chmod +x gradlew

      - name: Build lib module
        run: ./gradlew :carbon:build --scan --stacktrace -x check

  lib-check:
    name: Run check tasks on library module
    runs-on: ubuntu-latest
    needs: lib-build
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: adopt

      - name: Set up Gradle cache
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-gradle-${{ github.run_id }}
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper

      - name: Check :carbon
        run: ./gradlew :carbon:check

      - name: Tests reporting
        uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          report_paths: '**/test-results/testReleaseUnitTest/**/*.xml'
          detailed_summary: true

  catalog-app-build:
    name: Build catalog app
    runs-on: ubuntu-latest
    needs: lib-build
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: adopt

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Set up Gradle cache
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-gradle-${{ github.run_id }}
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper

      - name: Build catalog app
        run: ./gradlew :catalog-android:build -x check

  delete-cache:
    name: Delete cache
    permissions: write-all
    if: always()
    runs-on: ubuntu-latest
    needs: [ lib-check, catalog-app-build ]
    steps:
      - uses: actions/checkout@v4

      - name: Delete cache
        run: |
          gh extension install actions/gh-actions-cache
          set +e
          gh actions-cache delete ${{ runner.os }}-gradle-${{ github.run_id }} --confirm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
